<script>
let sessionId = null;

const statusBox = document.getElementById("status");
const answerBox = document.getElementById("answer");
const connectBtn = document.getElementById("connectBtn");
const indexBtn = document.getElementById("indexBtn");
const askBtn = document.getElementById("askBtn");

function setBusy(btn, busy, labelWhenBusy) {
  btn.disabled = busy;
  if (labelWhenBusy) btn.textContent = busy ? labelWhenBusy : btn.dataset.label;
}

async function readResponse(res) {
  const contentType = res.headers.get("content-type") || "";
  if (contentType.includes("application/json")) {
    return await res.json();
  }
  // fallback: read as text
  const txt = await res.text();
  return { detail: txt };
}

async function postJson(url, payload) {
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  const data = await readResponse(res);

  if (!res.ok) {
    const msg =
      (data && (data.detail || data.message)) ||
      `Request failed with status ${res.status}`;
    throw new Error(msg);
  }

  return data;
}

// store original labels
connectBtn.dataset.label = connectBtn.textContent;
indexBtn.dataset.label = indexBtn.textContent;
askBtn.dataset.label = askBtn.textContent;

connectBtn.onclick = async () => {
  statusBox.textContent = "Connecting...";
  answerBox.textContent = "";

  setBusy(connectBtn, true, "Connecting...");
  indexBtn.disabled = true;
  askBtn.disabled = true;

  const payload = {
    host: document.getElementById("host").value.trim(),
    port: parseInt(document.getElementById("port").value || "3306", 10),
    user: document.getElementById("user").value.trim(),
    password: document.getElementById("password").value,
    database: document.getElementById("database").value.trim(),
  };

  try {
    const data = await postJson("/api/connect", payload);

    sessionId = data.session_id;

    statusBox.textContent =
      "Connected ✅\nSession: " + sessionId +
      "\nTables: " + (data.tables || []).join(", ");

    indexBtn.disabled = false;
    askBtn.disabled = false;
  } catch (e) {
    console.error(e);
    statusBox.textContent = "Connect failed ❌\n" + e.message;
  } finally {
    setBusy(connectBtn, false);
  }
};

indexBtn.onclick = async () => {
  if (!sessionId) return;

  statusBox.textContent = "Indexing...";
  setBusy(indexBtn, true, "Indexing...");

  const maxRows = parseInt(document.getElementById("maxRows").value || "500", 10);

  try {
    const data = await postJson("/api/index_all", {
      session_id: sessionId,
      max_rows: maxRows,
    });

    statusBox.textContent =
      "Index complete ✅\n" + JSON.stringify(data.stats || data, null, 2);
  } catch (e) {
    console.error(e);
    statusBox.textContent = "Index failed ❌\n" + e.message;
  } finally {
    setBusy(indexBtn, false);
  }
};

askBtn.onclick = async () => {
  if (!sessionId) return;

  const q = document.getElementById("question").value.trim();
  if (!q) {
    answerBox.textContent = "Please type a question.";
    return;
  }

  answerBox.textContent = "Thinking...";
  setBusy(askBtn, true, "Thinking...");

  try {
    const data = await postJson("/api/ask", {
      session_id: sessionId,
      question: q,
    });

    answerBox.textContent = JSON.stringify(data, null, 2);
  } catch (e) {
    console.error(e);
    answerBox.textContent = "Ask failed ❌\n" + e.message;
  } finally {
    setBusy(askBtn, false);
  }
};
</script>
